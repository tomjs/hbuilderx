<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      #webview-patch-iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .outer {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
    </style>

    <script type="module" id="webview-patch">
      const TAG = '[@tomjs:hbuilderx:extension] ';

      function onDomReady(callback, doc) {
        const _doc = doc || document;
        if (_doc.readyState === 'interactive' || _doc.readyState === 'complete') {
          callback();
        } else {
          _doc.addEventListener('DOMContentLoaded', callback);
        }
      }

      // message handler
      let iframeLoaded = false;
      const cacheMessages = [];

      onDomReady(function () {
        /**  @type {HTMLIFrameElement} */
        const iframe = document.getElementById('webview-patch-iframe');

        onDomReady(function () {
          iframeLoaded = true;
        }, iframe.contentDocument);

        iframe.addEventListener('load', function (e) {
          iframeLoaded = true;
        });
      });

      function handleMessage(e) {
        const iframe = document.getElementById('webview-patch-iframe');
        if (!iframeLoaded || !iframe) {
          return;
        }
        if ('{{serverUrl}}'.startsWith(e.origin)) {
          const { type, data } = e.data;
          console.log(TAG + ' received:', e.data);
          if (type === '[hbuilderx:client]:postMessage') {
            hbuilderx.postMessage(data);
          }
        }
      }

      window.addEventListener('message', function (event) {
        handleMessage(event);
      });
    </script>
  </head>

  <body>
    <div class="outer">
      <iframe
        id="webview-patch-iframe"
        frameborder="0"
        sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-downloads"
        allow="cross-origin-isolated; autoplay; clipboard-read; clipboard-write"
        src="{{serverUrl}}"
      ></iframe>
    </div>
  </body>
</html>
